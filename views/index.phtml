<?
use Carbon\Carbon;
use Tracy\Debugger;
?>
<!-- mode: web -->
<!doctype html>
<html lang="en">
    <?php Debugger::renderLoader() ?>
    <head>
        <meta charset="UTF-8"/>
        <title>Worth the Weight!</title>
        <?=Flight::render("generated/resources", [])?>
        <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2016%2016'%3E%3Ctext%20x='0'%20y='14'%3EðŸ¦„%3C/text%3E%3C/svg%3E" type="image/svg+xml" />
    </head>
    <body hx-ext="path-deps">
        <? if (true === DEBUG) { ?>
            <button type="button"
                    onclick="delayedReload(500)"
                    class="button alert"
                    style="position:fixed;left:0;bottom:0"
                    name='drop-food-records'
                    hx-swap='none'
                    hx-post="/drop-food-log">
                DELETE ENTIRE FOOD LOG</button>
        <? } ?>
        <div hx-trigger="showMessage"></div>
        <div class="title-bar">
            <div class="title-bar-left">
                <button class="menu-icon" type="button" data-toggle="offCanvas"></button>
                <span class="title-bar-title">View your journal</span>
            </div>
            <div class='text-center'
                 hx-get='/food-support-message'
                 hx-trigger="path-deps"
                 hx-swap='innerHTML'
                 path-deps="/journal-entry"><?=Flight::welcome()?></div>
            <div class="title-bar-right">
                <span><?=(1 == DEBUG) ? " The date is " . Carbon::now()->format("D M j, Y") : ""?></span>
            </div>
            <div class="title-bar-right">
                <span class="title-bar-title">View graphs</span>
                <button class="menu-icon" type="button" data-toggle="offCanvas2"></button>
            </div>
        </div>

        <div class="off-canvas-wrapper">
            <div class="off-canvas position-left off-canvas-absolute" id="offCanvas" data-off-canvas
                 hx-get="/off-canvas-left/rel/<?=Flight::get('omo')?>"
                 hx-trigger="path-deps"
                 path-deps="/journal-entry">
                <?=Flight::render("partials/offcanvas-menu", [
                    "journal_day_offset" => Flight::get('omo')
                ])?>
            </div>

            <div class="off-canvas position-right off-canvas-absolute" id="offCanvas2" data-off-canvas>
                <?=Flight::render("partials/offcanvas-graphs", [
                    "journal_day_offset" => Flight::get('ogo')
                ])?>
            </div>
            <div class="off-canvas-content" data-off-canvas-content>
                <div class="grid-container">

                    <div class="grid-x grid-margin-x align-middle">
                        <div class="cell small-12 large-4">
                            <form name='food-log-form' class="grid-x" onsubmit="this.reset()">
                                <fieldset class="cell small-12 fieldset">
                                    <legend>food info</legend>
                                    <div class='form-group'>
                                        <label><strong>Select date</strong></label>
                                        <input class="form-control" name="date" type="date" value="<?=Carbon::now()->format("Y-m-d")?>" required/>
                                    </div>
                                    <div class="form-group">
                                        <label><strong>Select food:</strong></label>
                                        <select id="food-selection" name='food-selection' class='form-control' required>
                                            <option value="" selected>Select food ...</option>
                                            <? foreach ($foods as $food) { ?>
                                                <option value="<?=$food['id']?>"><?=$food['food']?> (<?=$food['points']?> points)</option>
                                            <? } ?>
                                        </select>
                                    </div>
                                </fieldset>
                                <fieldset class="cell small-12 fieldset">
                                    <div class="form-group">
                                        <label><strong>Multiplier <small>(fraction of food selection base quantity)</small></strong></label>
                                        <input class='form-control' type="text" name="amount" value="" data-inputmask="'alias': 'numeric'" required />
                                    </div>
                                </fieldset>
                                <button type="submit" class="button success large"
                                        hx-post="/journal-entry"
                                        hx-swap="none">submit</button>
                            </form>
                        </div>

                        <div class="cell small-12 large-8">
                            <div class="grid-x grid-margin-x align-center-middle">
                                <?
                                Flight::render("partials/big-picture", [
                                    "journal_day_offset" => Flight::get('bpo'),
                                ])
                                ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>

         $(document).on("keyup", "[name='searchbox']", debounce(function(e) {

             const $searchbox = $(e.currentTarget);
             const data = {
                 searchvalue: $searchbox.val()
             };

             fetch("/search", {
                 method: "POST",
                 headers: {
                     'Content-Type': 'application/json'
                 },
                 body: JSON.stringify(data),
             })
                 .then(response => response.json())
                 .then((json) => {
                     const data = dlv(json, 'response.data');
                     if (true == Array.isArray(data)) {
                         const $select = $("[name='food-selection']");
                         $select.empty();
                         $.each(data, function(index, item) {
                             $select.append(`<option value="${item.id}">${item.food}</option>`);
                         });

                         if (0 == data.length) {
                             $select.append(`<option>NO RESULTS</option>`);
                         }
                     }
                 });
         }, 700, false));

         htmx.onLoad(function(elt){
             if ("this-container2" == elt.id) {
                 initCalendar()
             }
         });

         // looks to be causing issues
         /* $(document).on("submit", "form", function (e) {
          *     console.log(e)
          * }); */

         /* $(document).on("click", "[type='submit']", function(e) {
          *     const $form = $(e.currentTarget).parents("form");
          *     $form[0].reset();
          *     $('select', $form).val('').trigger('change');
          * }); */

         $(document).on("showMessage", function (e) {
             $.notify(e.detail.message, e.detail.level);
         });

        </script>
    </body>
</html>
