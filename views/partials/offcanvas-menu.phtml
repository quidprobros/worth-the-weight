<?
use Carbon\Carbon;

if (empty($journal_day_offset)) {
    $journal_view_date = Flight::now("D M j, Y");
    $journal_date = date("Y-m-d");
    $colloqial_date = "&nbsp";
} else {
    $journal_view_date = date_create()->add(date_interval_create_from_date_string ("{$journal_day_offset} days"))->format("D M j, Y");
    $journal_date = date_create()->add(date_interval_create_from_date_string ("{$journal_day_offset} days"))->format("Y-m-d 00:00:00");

    switch(strtotime($journal_date)) {
        case (strtotime("yesterday")):
            $colloqial_date = "yesterday";
            break;
        case (date("Y-m-d")):
            $colloqial_date = "today";
            break;
        default:
            $colloqial_date = "&nbsp;";
            break;
    }
}


$stats = Flight::stats();

$records = Flight::journalItem()->whereDate("date", "=", $journal_date)->get();

$today_points = $stats->points($journal_day_offset);


$daily_model = \App\Models\Daily::firstWhere("date", $journal_date);
if (empty($daily_model)) {
    $daily_model = \App\Models\Daily::create([
        "date" => $journal_date,
        "exercised" => 0
    ]);
}

$exercised = $daily_model->exercised;

$prev = $journal_day_offset - 1;
$next = $journal_day_offset + 1;
?>

<!-- Your menu or Off-canvas content goes here -->
<div id='this-container' class="grid-y">
    <div class="cell">
        <div class="button-group align-spaced align-middle">
            <a class="button" title="see entry for yesterday"
               hx-indicator="#indicator"
               hx-get='<?=Flight::url()->sign("/journal/rel/{$prev}")?>'
               hx-swap="outerHTML"
               hx-target='#this-container'>⬅</a>
            <a hx-get='<?=Flight::url()->sign("/journal/rel/0")?>'
               hx-swap="outerHTML"
               hx-trigger="click"
               hx-target='#this-container'><h1 style='margin:0'><?=$journal_view_date?></h1></a>
            <a class='button' title="see entry for tomorrow"
               hx-get='<?=Flight::url()->sign("/journal/rel/{$next}")?>'
               hx-swap="outerHTML"
               hx-target='#this-container'>⮕</a>
        </div>
        <? if (0 == $journal_day_offset) { ?>
            <p class="text-center"><small>today</small></p>
        <? } else { ?>
            <p class="text-center"><small>&nbsp;</small></p>
        <? } ?>
    </div>
    <div class="cell">
        <div class="callout">
            <strong>Consumed: <?=$today_points?> points</strong>
            <br>
            <strong>Exercised this day: <?=$exercised ? "YES!": "NOPE"?></strong>
        </div>
    </div>
    <div class="cell">
        <div class='callout'>
            <div class="table-scroll">
                <?=Flight::render("partials/journal", [
                    "records" => \Flight::journalItem()->whereDate("date", "=", Carbon::now()->addDays($journal_day_offset))->get(),
                    "offset" => $journal_day_offset,
                ])?>
            </div>
        </div>
    </div>
</div>
