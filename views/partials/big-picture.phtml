<?

if (empty($journal_day_offset)) {
    $journal_view_date = Flight::now("D M j, Y");
    $journal_date = date("Y-m-d");
    $colloqial_date = "&nbsp";
} else {
    $journal_view_date = date_create()->add(date_interval_create_from_date_string ("{$journal_day_offset} days"))->format("D M j, Y");
    $journal_date = date_create()->add(date_interval_create_from_date_string ("{$journal_day_offset} days"))->format("Y-m-d");
}

switch(strtotime($journal_date)) {
    case (strtotime("yesterday")):
        $title = "yesterday";
        break;
    case (date("Y-m-d")):
        $title = "today";
        break;
    default:
        $title = "Count for {$journal_view_date}";
        break;
}

$stats = Flight::stats();

$records = $stats->journalEntries($journal_day_offset);

$today_points = $stats->points($journal_day_offset);


$daily_model = \App\Models\Daily::firstWhere("date", $journal_date);

$exercised = $daily_model->exercised;

?>
<div id="big-picture" class="card custom-shadow">
    <div class="card-divider button-group align-justify">
        <a class="button" title="see total for previous day"
           hx-trigger="click, keyup[shiftKey&&key=='A'] from:body"
           hx-get="/big-picture/rel/<?=($journal_day_offset - 1)?>"
           hx-swap="outerHTML swap:200ms"
           hx-target='#big-picture'>⬅</a>
        <h4><a title="see total for today"
               hx-trigger="click, keyup[shiftKey&&key=='S'] from:body"
               hx-get="/big-picture/rel/0"
               hx-swap="outerHTML swap:200ms"
               hx-target='#big-picture'><?=$title?></a></h4>
        <a class="button" title="see total for next day"
           hx-trigger="click, keyup[shiftKey&&key=='D'] from:body"
           hx-get="/big-picture/rel/<?=($journal_day_offset + 1)?>"
           hx-swap="outerHTML swap:200ms"
           hx-target='#big-picture'>⮕</a>
    </div>
    <div class="card-section">
        <div class="callout secondary text-center">
            <div id="today-total" style="font-size:5rem"><?=number_format($today_points, 1)?> points</div>
        </div>
    </div>
    <div class="card-section">
        <form action="" name="day-info">
            <fieldset class="cell small-12 fieldset">
                <input name="exercised"
                       type="checkbox"
                       hx-post="/exercised/rel/<?=$journal_day_offset?>"
                       <?=(1 == $exercised) ? "checked":""?>
                />
                <label for="exercised">Did you exercise today?</label>
                <br>
                <?=Flight::render("partials/exercised-statement", ["exercised" => $exercised])?>
            </fieldset>
        </form>
    </div>
    <div class="card-footer">
        <div class="cell auto">
            <div id="statistics" class="callout">
                <p>
                    You are averaging <strong><?=number_format(Flight::stats()->avgDaily(), 2)?></strong> points/day.
                </p>
                <p>
                    Trailing 7-day average: <strong><?=number_format(Flight::stats()->avgDailyTrailing7(), 2)?></strong> points/day
                </p>
            </div>
        </div>
    </div>
</div>
<?=Flight::render("partials/message", [
    "message" => isset($payload) ? $payload->getMessages()[0] : "",
    "status" => isset($payload) ? $payload->getStatus() : ""
])?>
